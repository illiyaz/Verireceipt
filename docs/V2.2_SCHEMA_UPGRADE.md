# V2.2 Schema Upgrade: Enhanced Explainability

**Status:** âœ… Production Ready  
**Version:** 2.2  
**Date:** 2024-01-16

---

## ğŸ¯ Purpose

Improve explainability and debugging for multi-address detection without leaking sensitive data.

**Problem:** V2.2 initial schema only returned counts and statuses, making it hard to:
- Debug false positives/negatives
- Build human review tooling
- Create labeling pipelines
- Understand why addresses were deemed distinct

**Solution:** Add two debug-only fields that provide explainability while preserving privacy.

---

## ğŸ“Š Schema Changes

### Before (V2.2 Initial)

```python
{
  "status": "MULTIPLE",
  "count": 3,
  "address_types": ["STANDARD", "STANDARD", "PO_BOX"],
  "evidence": ["distinct_postal_tokens", "distinct_address_types"]
}
```

### After (V2.2 Upgrade)

```python
{
  "status": "MULTIPLE",
  "count": 3,
  "address_types": ["STANDARD", "STANDARD", "PO_BOX"],
  "evidence": ["distinct_postal_tokens", "distinct_address_types"],
  "distinctness_basis": ["postal_tokens", "address_type"],  # NEW
  "candidates_preview": [                                    # NEW
    {
      "type": "STANDARD",
      "confidence": "STRONG_ADDRESS",
      "preview": "123 Main St, City 12345..."
    },
    {
      "type": "STANDARD",
      "confidence": "STRONG_ADDRESS",
      "preview": "456 Business Blvd, Town 67890..."
    },
    {
      "type": "PO_BOX",
      "confidence": "PLAUSIBLE_ADDRESS",
      "preview": "PO Box 789, City 54321..."
    }
  ]
}
```

---

## ğŸ†• New Fields

### 1. `distinctness_basis`

**Type:** `List[str]`

**Purpose:** Explains **why** addresses were deemed distinct.

**Values:**
- `"postal_tokens"` - Different postal codes detected (e.g., 12345 vs 67890)
- `"address_type"` - Different types (STANDARD vs PO_BOX)
- `"structural_separation"` - Separated by document structure (default fallback)

**Example:**
```python
"distinctness_basis": ["postal_tokens", "address_type"]
# Interpretation: Addresses are distinct because they have different 
# postal codes AND different types (STANDARD vs PO_BOX)
```

**Use Cases:**
- **Debugging:** Understand why multi-address was triggered
- **Tuning:** Identify which signals are most reliable
- **Rules:** Gate on specific distinctness types
  ```python
  if "postal_tokens" in multi_address_profile["distinctness_basis"]:
      # High confidence - postal codes are strong signals
      pass
  ```

---

### 2. `candidates_preview`

**Type:** `List[Dict[str, str]]`

**Purpose:** Provide **truncated preview** of detected addresses for debugging.

**Structure:**
```python
{
  "type": "STANDARD" | "PO_BOX",
  "confidence": "PLAUSIBLE_ADDRESS" | "STRONG_ADDRESS",
  "preview": str  # First 50 chars + "..."
}
```

**Privacy Protection:**
- âœ… Text truncated to 50 characters
- âœ… Limited to top 5 candidates
- âœ… No full addresses exposed
- âœ… Sufficient for debugging without PII leakage

**Example:**
```python
"candidates_preview": [
  {
    "type": "STANDARD",
    "confidence": "STRONG_ADDRESS",
    "preview": "ACME LOGISTICS LTD\nGSTIN: 29ABCDE1234F1Z5\n123 Indu..."
  },
  {
    "type": "STANDARD",
    "confidence": "STRONG_ADDRESS",
    "preview": "Bill To:\nXYZ Corporation\n456 Business Blvd\nMu..."
  }
]
```

**Use Cases:**
- **Human Review:** Show previews in review UI
- **Labeling:** Help annotators understand detections
- **Debugging:** Quickly identify false positives
- **Feedback Loops:** Collect corrections from reviewers

---

## ğŸ” Example Outputs

### Case 1: Single Address

```python
{
  "status": "SINGLE",
  "count": 1,
  "address_types": ["STANDARD"],
  "evidence": ["one_address_candidate"],
  "candidates_preview": [
    {
      "type": "STANDARD",
      "confidence": "STRONG_ADDRESS",
      "preview": "123 Main Street\nSpringfield, IL 62701..."
    }
  ]
}
```

### Case 2: Multiple Addresses (Distinct Postal Codes)

```python
{
  "status": "MULTIPLE",
  "count": 3,
  "address_types": ["STANDARD", "STANDARD", "STANDARD"],
  "evidence": ["distinct_postal_tokens"],
  "distinctness_basis": ["postal_tokens"],
  "candidates_preview": [
    {
      "type": "STANDARD",
      "confidence": "STRONG_ADDRESS",
      "preview": "Merchant: Acme Corp\n123 Main St\nCity 12345..."
    },
    {
      "type": "STANDARD",
      "confidence": "STRONG_ADDRESS",
      "preview": "Bill To: XYZ Inc\n456 Business Blvd\nTown 678..."
    },
    {
      "type": "STANDARD",
      "confidence": "STRONG_ADDRESS",
      "preview": "Ship To: ABC Warehouse\n789 Logistics Ln\nVil..."
    }
  ]
}
```

### Case 3: Multiple Addresses (Different Types)

```python
{
  "status": "MULTIPLE",
  "count": 2,
  "address_types": ["STANDARD", "PO_BOX"],
  "evidence": ["distinct_address_types"],
  "distinctness_basis": ["address_type"],
  "candidates_preview": [
    {
      "type": "STANDARD",
      "confidence": "STRONG_ADDRESS",
      "preview": "Corporate HQ\n123 Main Street\nCity 12345..."
    },
    {
      "type": "PO_BOX",
      "confidence": "PLAUSIBLE_ADDRESS",
      "preview": "Mailing Address\nPO Box 789\nCity 12345..."
    }
  ]
}
```

### Case 4: Gated (Low Confidence)

```python
{
  "status": "UNKNOWN",
  "count": 0,
  "address_types": [],
  "evidence": ["gated_low_doc_confidence"],
  "candidates_preview": []
}
```

---

## ğŸ¨ Human Review UI Mockup

### Multi-Address Detection Card

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Multi-Address Detection                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Status: MULTIPLE                                        â”‚
â”‚ Count: 3 distinct addresses                             â”‚
â”‚ Distinctness: postal_tokens, address_type               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Detected Addresses:                                     â”‚
â”‚                                                         â”‚
â”‚ 1. [STANDARD] STRONG_ADDRESS                            â”‚
â”‚    "ACME LOGISTICS LTD\nGSTIN: 29ABCDE1234F1Z5..."     â”‚
â”‚                                                         â”‚
â”‚ 2. [STANDARD] STRONG_ADDRESS                            â”‚
â”‚    "Bill To:\nXYZ Corporation\n456 Business Blvd..."   â”‚
â”‚                                                         â”‚
â”‚ 3. [PO_BOX] PLAUSIBLE_ADDRESS                           â”‚
â”‚    "Mailing:\nPO Box 789\nCity 54321..."               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸš€ Integration Examples

### Example 1: Rule Gating on Distinctness Type

```python
def rule_high_confidence_multi_address(multi_address_profile):
    """Only trigger if distinctness is based on postal codes."""
    if multi_address_profile["status"] != "MULTIPLE":
        return {"status": "NOT_TRIGGERED"}
    
    # Gate on distinctness type
    if "postal_tokens" in multi_address_profile.get("distinctness_basis", []):
        return {
            "status": "TRIGGERED",
            "rule_id": "HIGH_CONF_MULTI_ADDRESS",
            "evidence": {
                "count": multi_address_profile["count"],
                "distinctness": multi_address_profile["distinctness_basis"],
            },
        }
    
    return {"status": "NOT_TRIGGERED"}
```

### Example 2: Human Review Tooling

```python
def render_multi_address_card(multi_address_profile):
    """Render multi-address detection for human review."""
    if multi_address_profile["status"] == "UNKNOWN":
        return "<div>No addresses detected (gated)</div>"
    
    html = f"""
    <div class="multi-address-card">
        <h3>Multi-Address Detection</h3>
        <p>Status: {multi_address_profile['status']}</p>
        <p>Count: {multi_address_profile['count']}</p>
        <p>Distinctness: {', '.join(multi_address_profile.get('distinctness_basis', []))}</p>
        
        <h4>Detected Addresses:</h4>
        <ul>
    """
    
    for i, candidate in enumerate(multi_address_profile.get("candidates_preview", [])):
        html += f"""
            <li>
                <strong>[{candidate['type']}] {candidate['confidence']}</strong><br>
                <code>{candidate['preview']}</code>
            </li>
        """
    
    html += "</ul></div>"
    return html
```

### Example 3: Labeling Pipeline

```python
def create_labeling_task(doc_id, multi_address_profile):
    """Create labeling task for human annotators."""
    if multi_address_profile["status"] != "MULTIPLE":
        return None  # Only label multi-address cases
    
    return {
        "doc_id": doc_id,
        "task_type": "multi_address_validation",
        "question": "Are these distinct addresses?",
        "candidates": [
            {
                "preview": c["preview"],
                "type": c["type"],
                "confidence": c["confidence"],
            }
            for c in multi_address_profile.get("candidates_preview", [])
        ],
        "distinctness_basis": multi_address_profile.get("distinctness_basis", []),
        "instructions": "Review the detected addresses and confirm if they are truly distinct.",
    }
```

---

## ğŸ“Š Telemetry Integration

The telemetry system automatically tracks these new fields:

```python
from app.telemetry import get_global_metrics

metrics = get_global_metrics()
summary = metrics.get_summary()

# Distinctness basis distribution
# (requires custom counter - not yet implemented)
```

**Future Enhancement:** Add counters for `distinctness_basis` distribution:
- `multi_address.distinctness.postal_tokens`
- `multi_address.distinctness.address_type`
- `multi_address.distinctness.structural_separation`

---

## ğŸ”’ Privacy & Security

**What's Safe:**
- âœ… Truncated previews (50 chars)
- âœ… Limited to top 5 candidates
- âœ… No full addresses
- âœ… No merchant names (unless in first 50 chars)
- âœ… Sufficient for debugging

**What to Avoid:**
- âŒ Don't log full `candidates_preview` to external systems
- âŒ Don't expose in public APIs without review
- âŒ Don't use for analytics without aggregation

**Recommendation:** Treat `candidates_preview` as **debug-only** data. Use for:
- Internal review tooling
- Labeling pipelines (internal)
- Debugging (development/staging)

---

## âœ… Backward Compatibility

**Guaranteed:**
- All existing fields remain unchanged
- New fields are additive only
- Old code ignores new fields gracefully

**Migration:** None required. Existing code continues to work.

---

## ğŸ¯ Impact

**Before Upgrade:**
- âŒ Hard to debug false positives
- âŒ No visibility into detection logic
- âŒ Difficult to build review tooling
- âŒ Labeling pipelines require full document access

**After Upgrade:**
- âœ… Clear explainability via `distinctness_basis`
- âœ… Debug previews via `candidates_preview`
- âœ… Easy to build review UIs
- âœ… Labeling pipelines work with truncated data

---

## ğŸ“š Related Documentation

- `ADDRESS_VALIDATION_V1.md` - Full V1/V2.1/V2.2 documentation
- `docs/REFERENCE_RULES_ADDRESS.md` - Rule patterns using these fields
- `docs/TELEMETRY_ADDRESS.md` - Metrics and observability
- `tests/golden/address_cases.json` - Golden test cases

---

**Last Updated:** 2024-01-16  
**Version:** 2.2 (Schema Upgrade)  
**Status:** Production Ready
