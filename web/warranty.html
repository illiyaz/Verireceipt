<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VeriReceipt - Warranty Claims Fraud Detection</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
        }
        
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .card-shadow {
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
        }
        
        .dropzone {
            border: 3px dashed #cbd5e0;
            transition: all 0.3s ease;
        }
        
        .dropzone.drag-over {
            border-color: #667eea;
            background-color: #f7fafc;
        }
        
        .pulse-animation {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: .5; }
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .badge-approve {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }
        
        .badge-review {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }
        
        .badge-investigate {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .signal-high { background-color: #fef2f2; border-left: 4px solid #ef4444; }
        .signal-medium { background-color: #fffbeb; border-left: 4px solid #f59e0b; }
        .signal-low { background-color: #f0fdf4; border-left: 4px solid #22c55e; }
        .tab-active { border-bottom: 3px solid #667eea; color: #667eea; font-weight: 600; }
        .tab-inactive { border-bottom: 3px solid transparent; color: #6b7280; }
        .tab-inactive:hover { color: #374151; border-color: #d1d5db; }
    </style>
</head>
<body class="bg-gray-50">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useRef, useEffect } = React;
        const API_BASE_URL = window.location.origin;

        function App() {
            const [file, setFile] = useState(null);
            const [preview, setPreview] = useState(null);
            const [analyzing, setAnalyzing] = useState(false);
            const [result, setResult] = useState(null);
            const [error, setError] = useState(null);
            const [dragOver, setDragOver] = useState(false);
            const [dealerId, setDealerId] = useState('');
            const [feedbackSubmitted, setFeedbackSubmitted] = useState(false);
            const [feedbackVerdict, setFeedbackVerdict] = useState(null);
            const [feedbackError, setFeedbackError] = useState(null);
            const [dupAudit, setDupAudit] = useState(null);
            const [dupExpanded, setDupExpanded] = useState({});
            const [activeTab, setActiveTab] = useState('analyze');
            const [claimModal, setClaimModal] = useState(null);
            const [claimModalLoading, setClaimModalLoading] = useState(false);
            // Dashboard state
            const [dashOverview, setDashOverview] = useState(null);
            const [dashRootCauses, setDashRootCauses] = useState(null);
            const [dashBrands, setDashBrands] = useState(null);
            const [dashDealers, setDashDealers] = useState(null);
            const [dashSignals, setDashSignals] = useState(null);
            const [dashDupStats, setDashDupStats] = useState(null);
            const [dashTrends, setDashTrends] = useState(null);
            const [dashLoading, setDashLoading] = useState(false);
            const [drilldown, setDrilldown] = useState(null);
            const [drillClaims, setDrillClaims] = useState(null);
            const [drillLoading, setDrillLoading] = useState(false);
            const fileInputRef = useRef(null);

            const loadDuplicateAudit = async (claimId) => {
                try {
                    const resp = await fetch(`${API_BASE_URL}/warranty/duplicates/${claimId}`);
                    if (resp.ok) {
                        const data = await resp.json();
                        setDupAudit(data);
                    }
                } catch (e) {
                    console.error('Failed to load duplicate audit:', e);
                }
            };

            const toggleDupExpand = (idx) => {
                setDupExpanded(prev => ({ ...prev, [idx]: !prev[idx] }));
            };

            const getMatchIcon = (type) => {
                switch(type) {
                    case 'IMAGE_EXACT': return { icon: 'fa-clone', color: 'text-red-600', bg: 'bg-red-100' };
                    case 'IMAGE_LIKELY_SAME': return { icon: 'fa-images', color: 'text-orange-600', bg: 'bg-orange-100' };
                    case 'IMAGE_SIMILAR': return { icon: 'fa-photo-video', color: 'text-yellow-600', bg: 'bg-yellow-100' };
                    case 'VIN_ISSUE_DUPLICATE': return { icon: 'fa-car', color: 'text-purple-600', bg: 'bg-purple-100' };
                    default: return { icon: 'fa-copy', color: 'text-gray-600', bg: 'bg-gray-100' };
                }
            };

            const openClaimDetail = async (claimId) => {
                setClaimModalLoading(true);
                setClaimModal(null);
                try {
                    const resp = await fetch(`${API_BASE_URL}/warranty/claim/${claimId}`);
                    if (resp.ok) {
                        const data = await resp.json();
                        setClaimModal(data);
                    } else {
                        setClaimModal({ _error: `Claim ${claimId} not found` });
                    }
                } catch (e) {
                    setClaimModal({ _error: e.message });
                }
                setClaimModalLoading(false);
            };

            const ClaimLink = ({ claimId, short }) => (
                <button
                    onClick={(e) => { e.stopPropagation(); openClaimDetail(claimId); }}
                    className="text-indigo-600 hover:text-indigo-800 hover:underline font-mono text-xs cursor-pointer"
                    title={`View claim ${claimId}`}
                >
                    {short ? claimId?.substring(0, 12) + '...' : claimId}
                </button>
            );

            const DASH_COLORS = ['#6366f1','#ec4899','#f59e0b','#10b981','#3b82f6','#ef4444','#8b5cf6','#14b8a6','#f97316','#06b6d4','#84cc16','#e11d48'];

            const loadDashboard = async () => {
                setDashLoading(true);
                try {
                    const [ov, rc, br, dl, sg, dp, tr] = await Promise.all([
                        fetch(`${API_BASE_URL}/warranty/dashboard/overview`).then(r => r.json()),
                        fetch(`${API_BASE_URL}/warranty/dashboard/root-causes`).then(r => r.json()),
                        fetch(`${API_BASE_URL}/warranty/dashboard/by-brand`).then(r => r.json()),
                        fetch(`${API_BASE_URL}/warranty/dashboard/by-dealer`).then(r => r.json()),
                        fetch(`${API_BASE_URL}/warranty/dashboard/signals`).then(r => r.json()),
                        fetch(`${API_BASE_URL}/warranty/dashboard/duplicates`).then(r => r.json()),
                        fetch(`${API_BASE_URL}/warranty/dashboard/trends`).then(r => r.json()),
                    ]);
                    setDashOverview(ov); setDashRootCauses(rc); setDashBrands(br);
                    setDashDealers(dl); setDashSignals(sg); setDashDupStats(dp); setDashTrends(tr);
                } catch (e) { console.error('Dashboard load failed:', e); }
                setDashLoading(false);
            };

            const openDrilldown = async (type, value, title) => {
                setDrilldown({ type, value, title });
                setDrillLoading(true);
                setDrillClaims(null);
                try {
                    const params = new URLSearchParams();
                    if (type === 'issue') params.set('issue', value);
                    if (type === 'brand') params.set('brand', value);
                    if (type === 'dealer') params.set('dealer_id', value);
                    if (type === 'triage') params.set('triage', value);
                    if (type === 'suspicious') params.set('suspicious_only', 'true');
                    const resp = await fetch(`${API_BASE_URL}/warranty/dashboard/claims?${params}`);
                    setDrillClaims(await resp.json());
                } catch (e) { console.error(e); }
                setDrillLoading(false);
            };

            const switchTab = (tab) => {
                setActiveTab(tab);
                if (tab === 'dashboard' && !dashOverview) loadDashboard();
            };

            // Auto-scroll to drilldown panel when it opens
            useEffect(() => {
                if (drilldown && !drillLoading) {
                    setTimeout(() => {
                        const el = document.getElementById('drilldown-panel');
                        if (el) el.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }, 100);
                }
            }, [drilldown, drillLoading]);

            const handleFile = (selectedFile) => {
                if (selectedFile && selectedFile.type === 'application/pdf') {
                    setFile(selectedFile);
                    setPreview(URL.createObjectURL(selectedFile));
                    setResult(null);
                    setError(null);
                    setFeedbackSubmitted(false);
                } else {
                    setError('Please upload a PDF file');
                }
            };

            const handleDrop = (e) => {
                e.preventDefault();
                setDragOver(false);
                const droppedFile = e.dataTransfer.files[0];
                handleFile(droppedFile);
            };

            const analyzeWarranty = async () => {
                if (!file) return;
                
                setAnalyzing(true);
                setError(null);
                setResult(null);

                const formData = new FormData();
                formData.append('file', file);
                if (dealerId) {
                    formData.append('dealer_id', dealerId);
                }

                try {
                    const response = await fetch(`${API_BASE_URL}/warranty/analyze`, {
                        method: 'POST',
                        body: formData
                    });

                    if (!response.ok) {
                        throw new Error(`Analysis failed: ${response.statusText}`);
                    }

                    const data = await response.json();
                    setResult(data);
                    setDupAudit(null);
                    setDupExpanded({});
                    // Load enriched duplicate audit
                    if (data.claim_id && data.duplicates_found?.length > 0) {
                        loadDuplicateAudit(data.claim_id);
                    }
                    // Clear upload form after successful analysis
                    setFile(null);
                    setPreview(null);
                    setDealerId('');
                    setFeedbackSubmitted(false);
                    setFeedbackVerdict(null);
                } catch (err) {
                    setError(err.message);
                } finally {
                    setAnalyzing(false);
                }
            };

            const submitFeedback = async (verdict) => {
                if (!result?.claim_id) {
                    setFeedbackError('No claim ID available. Please analyze a document first.');
                    return;
                }
                setFeedbackError(null);

                try {
                    const response = await fetch(`${API_BASE_URL}/warranty/feedback`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            claim_id: result.claim_id,
                            verdict: verdict,
                            adjuster_id: 'web_user',
                            notes: `Feedback from web UI: ${verdict}`
                        })
                    });

                    if (response.ok) {
                        setFeedbackSubmitted(true);
                        setFeedbackVerdict(verdict);
                    } else {
                        const errData = await response.json().catch(() => ({}));
                        setFeedbackError(`Feedback failed (${response.status}): ${errData.detail || response.statusText}`);
                    }
                } catch (err) {
                    setFeedbackError(`Feedback error: ${err.message}`);
                    console.error('Feedback error:', err);
                }
            };

            const getTriageBadgeClass = (triage) => {
                switch(triage) {
                    case 'AUTO_APPROVE': return 'badge-approve';
                    case 'REVIEW': return 'badge-review';
                    case 'INVESTIGATE': return 'badge-investigate';
                    default: return 'bg-gray-500';
                }
            };

            const getTriageIcon = (triage) => {
                switch(triage) {
                    case 'AUTO_APPROVE': return 'fa-check-circle';
                    case 'REVIEW': return 'fa-exclamation-circle';
                    case 'INVESTIGATE': return 'fa-exclamation-triangle';
                    default: return 'fa-question-circle';
                }
            };

            const getSeverityClass = (severity) => {
                switch(severity) {
                    case 'HIGH': return 'signal-high';
                    case 'MEDIUM': return 'signal-medium';
                    case 'LOW': return 'signal-low';
                    default: return '';
                }
            };

            return (
                <div className="min-h-screen">
                    {/* Header */}
                    <header className="gradient-bg text-white py-6 shadow-lg">
                        <div className="max-w-7xl mx-auto px-4">
                            <div className="flex items-center justify-between mb-4">
                                <div className="flex items-center space-x-4">
                                    <i className="fas fa-shield-alt text-3xl"></i>
                                    <div>
                                        <h1 className="text-3xl font-bold">VeriReceipt</h1>
                                        <p className="text-purple-200 text-sm">Warranty Claims - AI Fraud Detection</p>
                                    </div>
                                </div>
                                <div className="flex items-center space-x-3">
                                    <a href="/web/index.html" className="px-3 py-1.5 bg-white bg-opacity-20 hover:bg-opacity-30 rounded-lg transition text-white text-sm">
                                        <i className="fas fa-receipt mr-1"></i>Receipts
                                    </a>
                                    <a href="/web/stats.html" className="px-3 py-1.5 bg-white bg-opacity-20 hover:bg-opacity-30 rounded-lg transition text-white text-sm">
                                        <i className="fas fa-chart-bar mr-1"></i>Analytics
                                    </a>
                                </div>
                            </div>
                            {/* Tabs */}
                            <div className="flex space-x-1 border-b border-white border-opacity-30">
                                <button onClick={() => switchTab('analyze')}
                                    className={`px-5 py-2.5 text-sm transition rounded-t-lg ${activeTab === 'analyze' ? 'bg-white text-indigo-700 font-semibold' : 'text-white hover:bg-white hover:bg-opacity-10'}`}>
                                    <i className="fas fa-upload mr-2"></i>Analyze Claim
                                </button>
                                <button onClick={() => switchTab('dashboard')}
                                    className={`px-5 py-2.5 text-sm transition rounded-t-lg ${activeTab === 'dashboard' ? 'bg-white text-indigo-700 font-semibold' : 'text-white hover:bg-white hover:bg-opacity-10'}`}>
                                    <i className="fas fa-tachometer-alt mr-2"></i>Dashboard
                                </button>
                            </div>
                        </div>
                    </header>

                    {/* ===================== ANALYZE TAB ===================== */}
                    {activeTab === 'analyze' && (
                    <main className="max-w-7xl mx-auto py-8 px-4">
                        <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
                            {/* Upload Section */}
                            <div className="bg-white rounded-2xl card-shadow p-6">
                                <h2 className="text-xl font-bold text-gray-800 mb-4">
                                    <i className="fas fa-upload mr-2 text-blue-600"></i>
                                    Upload Warranty Claim
                                </h2>

                                {/* Dealer ID Input */}
                                <div className="mb-4">
                                    <label className="block text-sm font-medium text-gray-700 mb-1">
                                        Dealer ID (Optional)
                                    </label>
                                    <input
                                        type="text"
                                        value={dealerId}
                                        onChange={(e) => setDealerId(e.target.value)}
                                        placeholder="Enter dealer ID for tracking"
                                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                    />
                                </div>

                                {/* Dropzone */}
                                <div
                                    className={`dropzone rounded-xl p-8 text-center cursor-pointer ${dragOver ? 'drag-over' : ''}`}
                                    onDragOver={(e) => { e.preventDefault(); setDragOver(true); }}
                                    onDragLeave={() => setDragOver(false)}
                                    onDrop={handleDrop}
                                    onClick={() => fileInputRef.current?.click()}
                                >
                                    <input
                                        type="file"
                                        ref={fileInputRef}
                                        className="hidden"
                                        accept=".pdf"
                                        onChange={(e) => handleFile(e.target.files[0])}
                                    />
                                    {preview ? (
                                        <div className="space-y-4">
                                            <i className="fas fa-file-pdf text-6xl text-red-500"></i>
                                            <p className="font-medium text-gray-700">{file?.name}</p>
                                            <p className="text-sm text-gray-500">{(file?.size / 1024).toFixed(1)} KB</p>
                                        </div>
                                    ) : (
                                        <div className="space-y-4">
                                            <i className="fas fa-cloud-upload-alt text-5xl text-gray-400"></i>
                                            <p className="text-gray-600">Drag & drop warranty claim PDF here</p>
                                            <p className="text-sm text-gray-400">or click to browse</p>
                                        </div>
                                    )}
                                </div>

                                {/* Analyze Button */}
                                <button
                                    onClick={analyzeWarranty}
                                    disabled={!file || analyzing}
                                    className={`w-full mt-6 py-4 rounded-xl text-white font-semibold transition ${
                                        !file || analyzing
                                            ? 'bg-gray-300 cursor-not-allowed'
                                            : 'bg-blue-600 hover:bg-blue-700'
                                    }`}
                                >
                                    {analyzing ? (
                                        <span className="flex items-center justify-center space-x-2">
                                            <div className="spinner"></div>
                                            <span>Analyzing Claim...</span>
                                        </span>
                                    ) : (
                                        <span><i className="fas fa-search mr-2"></i>Analyze for Fraud</span>
                                    )}
                                </button>

                                {error && (
                                    <div className="mt-4 p-4 bg-red-50 border border-red-200 rounded-lg text-red-700">
                                        <i className="fas fa-exclamation-circle mr-2"></i>{error}
                                    </div>
                                )}
                            </div>

                            {/* Results Section */}
                            <div className="bg-white rounded-2xl card-shadow p-6">
                                <h2 className="text-xl font-bold text-gray-800 mb-4">
                                    <i className="fas fa-clipboard-check mr-2 text-blue-600"></i>
                                    Analysis Results
                                </h2>

                                {!result && !analyzing && (
                                    <div className="text-center py-16 text-gray-400">
                                        <i className="fas fa-file-invoice text-6xl mb-4"></i>
                                        <p>Upload a warranty claim to see results</p>
                                    </div>
                                )}

                                {analyzing && (
                                    <div className="text-center py-16">
                                        <div className="spinner mx-auto mb-4" style={{width: '48px', height: '48px'}}></div>
                                        <p className="text-gray-600">Analyzing warranty claim...</p>
                                        <p className="text-sm text-gray-400 mt-2">Checking for duplicates, validating data, detecting fraud signals</p>
                                    </div>
                                )}

                                {result && (
                                    <div className="space-y-6 fade-in">
                                        {/* Triage Badge */}
                                        <div className="text-center">
                                            <span className={`inline-flex items-center px-6 py-3 rounded-full text-white font-bold text-lg ${getTriageBadgeClass(result.triage_class)}`}>
                                                <i className={`fas ${getTriageIcon(result.triage_class)} mr-2`}></i>
                                                {result.triage_class.replace('_', ' ')}
                                            </span>
                                            <p className="mt-2 text-gray-600">
                                                Risk Score: <span className="font-bold text-xl">{(result.risk_score * 100).toFixed(0)}%</span>
                                            </p>
                                        </div>

                                        {/* Claim Details */}
                                        <div className="bg-gray-50 rounded-xl p-4">
                                            <h3 className="font-semibold text-gray-700 mb-3">
                                                <i className="fas fa-info-circle mr-2"></i>Claim Details
                                            </h3>
                                            <div className="grid grid-cols-2 gap-3 text-sm">
                                                <div><span className="text-gray-500">Claim ID:</span> <span className="font-medium">{result.claim_id}</span></div>
                                                <div><span className="text-gray-500">Customer:</span> <span className="font-medium">{result.customer_name || 'N/A'}</span></div>
                                                <div><span className="text-gray-500">Vehicle:</span> <span className="font-medium">{result.brand} {result.model} ({result.year})</span></div>
                                                <div><span className="text-gray-500">VIN:</span> <span className="font-medium font-mono text-xs">{result.vin || 'N/A'}</span></div>
                                                <div><span className="text-gray-500">Issue:</span> <span className="font-medium">{result.issue_description}</span></div>
                                                <div><span className="text-gray-500">Claim Date:</span> <span className="font-medium">{result.claim_date}</span></div>
                                                <div><span className="text-gray-500">Total:</span> <span className="font-medium text-green-600">${result.total_amount?.toFixed(2)}</span></div>
                                                <div><span className="text-gray-500">Images:</span> <span className="font-medium">{result.images_extracted}</span></div>
                                            </div>
                                        </div>

                                        {/* Cost Breakdown */}
                                        <div className="bg-blue-50 rounded-xl p-4">
                                            <h3 className="font-semibold text-gray-700 mb-3">
                                                <i className="fas fa-dollar-sign mr-2"></i>Cost Breakdown
                                            </h3>
                                            <div className="grid grid-cols-3 gap-3 text-center">
                                                <div>
                                                    <p className="text-2xl font-bold text-blue-600">${result.parts_cost?.toFixed(2) || '0.00'}</p>
                                                    <p className="text-xs text-gray-500">Parts</p>
                                                </div>
                                                <div>
                                                    <p className="text-2xl font-bold text-blue-600">${result.labor_cost?.toFixed(2) || '0.00'}</p>
                                                    <p className="text-xs text-gray-500">Labor</p>
                                                </div>
                                                <div>
                                                    <p className="text-2xl font-bold text-blue-600">${result.tax?.toFixed(2) || '0.00'}</p>
                                                    <p className="text-xs text-gray-500">Tax</p>
                                                </div>
                                            </div>
                                        </div>

                                        {/* Duplicates Found — Enriched Audit */}
                                        {result.duplicates_found?.length > 0 && (
                                            <div className="bg-red-50 border border-red-200 rounded-xl p-4">
                                                <h3 className="font-semibold text-red-700 mb-1">
                                                    <i className="fas fa-copy mr-2"></i>
                                                    Duplicate Audit
                                                </h3>
                                                <p className="text-xs text-red-500 mb-3">
                                                    {dupAudit
                                                        ? `${dupAudit.total_duplicates} linked claim(s), ${dupAudit.total_matches} match(es)`
                                                        : `${result.duplicates_found.length} match(es) detected`}
                                                </p>

                                                {/* THIS CLAIM context banner */}
                                                <div className="bg-white border border-indigo-200 rounded-lg p-3 mb-3">
                                                    <div className="flex items-center space-x-2 mb-1">
                                                        <span className="bg-indigo-100 text-indigo-700 text-xs font-bold px-2 py-0.5 rounded">THIS CLAIM</span>
                                                        <ClaimLink claimId={result.claim_id} short={false} />
                                                    </div>
                                                    <div className="grid grid-cols-2 gap-1 text-xs text-gray-600">
                                                        <div><span className="text-gray-400">VIN:</span> <span className="font-mono">{result.vin || 'N/A'}</span></div>
                                                        <div><span className="text-gray-400">Vehicle:</span> {result.brand} {result.model} ({result.year})</div>
                                                        <div><span className="text-gray-400">Issue:</span> {result.issue_description || 'N/A'}</div>
                                                        <div><span className="text-gray-400">Total:</span> <span className="text-green-600 font-medium">${result.total_amount?.toFixed(2) || '0.00'}</span></div>
                                                    </div>
                                                </div>

                                                <p className="text-xs font-medium text-gray-500 mb-2 uppercase tracking-wide">
                                                    <i className="fas fa-arrow-down mr-1"></i>is a duplicate of:
                                                </p>

                                                {/* Grouped audit (enriched) */}
                                                {dupAudit?.grouped?.map((group, gIdx) => {
                                                    const expanded = dupExpanded[gIdx];
                                                    const cd = group.claim_details;
                                                    return (
                                                        <div key={gIdx} className="bg-white rounded-lg mb-3 border border-red-100 overflow-hidden">
                                                            {/* Header — always visible */}
                                                            <div
                                                                className="p-3 cursor-pointer hover:bg-red-50 transition flex items-center justify-between"
                                                                onClick={() => toggleDupExpand(gIdx)}
                                                            >
                                                                <div className="flex items-center space-x-3 flex-1 min-w-0">
                                                                    <div className="flex -space-x-1">
                                                                        {group.reason_types?.map((rt, ri) => {
                                                                            const mi = getMatchIcon(rt);
                                                                            return (
                                                                                <span key={ri} className={`inline-flex items-center justify-center w-7 h-7 rounded-full ${mi.bg} ${mi.color} text-xs`}>
                                                                                    <i className={`fas ${mi.icon}`}></i>
                                                                                </span>
                                                                            );
                                                                        })}
                                                                    </div>
                                                                    <div className="min-w-0 flex-1">
                                                                        <div className="flex items-center space-x-2">
                                                                            <span className="bg-red-100 text-red-700 text-xs font-bold px-1.5 py-0.5 rounded">LINKED</span>
                                                                            <ClaimLink claimId={group.matched_claim_id} short={true} />
                                                                        </div>
                                                                        <p className="text-xs text-gray-500 truncate mt-0.5">
                                                                            {group.reason_summary?.join(' + ')}
                                                                        </p>
                                                                    </div>
                                                                </div>
                                                                <div className="flex items-center space-x-3 ml-2">
                                                                    <span className="text-xs font-bold text-red-600 bg-red-100 px-2 py-1 rounded-full">
                                                                        {(group.max_similarity * 100).toFixed(0)}%
                                                                    </span>
                                                                    <i className={`fas fa-chevron-${expanded ? 'up' : 'down'} text-gray-400 text-xs`}></i>
                                                                </div>
                                                            </div>

                                                            {/* Expanded detail */}
                                                            {expanded && (
                                                                <div className="border-t border-red-100 p-3 bg-gray-50 text-sm space-y-3">
                                                                    {/* Side-by-side comparison */}
                                                                    {cd && (
                                                                        <div className="grid grid-cols-2 gap-3">
                                                                            {/* This Claim mini */}
                                                                            <div className="bg-indigo-50 rounded p-2 border border-indigo-100">
                                                                                <p className="text-xs font-bold text-indigo-600 mb-1"><i className="fas fa-file-invoice mr-1"></i>This Claim</p>
                                                                                <div className="text-xs space-y-0.5 text-gray-600">
                                                                                    <div><span className="text-gray-400">VIN:</span> <span className="font-mono">{result.vin || 'N/A'}</span></div>
                                                                                    <div><span className="text-gray-400">Issue:</span> {result.issue_description || 'N/A'}</div>
                                                                                    <div><span className="text-gray-400">Date:</span> {result.claim_date || 'N/A'}</div>
                                                                                    <div><span className="text-gray-400">Total:</span> ${result.total_amount?.toFixed(2) || '0.00'}</div>
                                                                                </div>
                                                                            </div>
                                                                            {/* Linked Claim */}
                                                                            <div className="bg-red-50 rounded p-2 border border-red-100">
                                                                                <p className="text-xs font-bold text-red-600 mb-1"><i className="fas fa-link mr-1"></i>Linked Claim</p>
                                                                                <div className="text-xs space-y-0.5 text-gray-600">
                                                                                    <div><span className="text-gray-400">VIN:</span> <span className="font-mono">{cd.vin || 'N/A'}</span></div>
                                                                                    <div><span className="text-gray-400">Issue:</span> {cd.issue_description || 'N/A'}</div>
                                                                                    <div><span className="text-gray-400">Date:</span> {cd.claim_date || 'N/A'}</div>
                                                                                    <div><span className="text-gray-400">Total:</span> ${cd.total_amount?.toFixed(2) || '0.00'}</div>
                                                                                </div>
                                                                            </div>
                                                                        </div>
                                                                    )}

                                                                    {/* Full linked claim details */}
                                                                    {cd && (
                                                                        <div>
                                                                            <p className="font-semibold text-gray-700 mb-1 text-xs">
                                                                                <i className="fas fa-id-card mr-1 text-blue-500"></i>Full Linked Claim Details
                                                                            </p>
                                                                            <div className="grid grid-cols-2 gap-2 text-xs bg-white rounded p-2 border">
                                                                                <div><span className="text-gray-400">Claim ID:</span> <ClaimLink claimId={cd.id} short={false} /></div>
                                                                                <div><span className="text-gray-400">Customer:</span> {cd.customer_name || 'N/A'}</div>
                                                                                <div><span className="text-gray-400">VIN:</span> <span className="font-mono">{cd.vin || 'N/A'}</span></div>
                                                                                <div><span className="text-gray-400">Vehicle:</span> {cd.brand} {cd.model} ({cd.year})</div>
                                                                                <div><span className="text-gray-400">Dealer:</span> {cd.dealer_name || cd.dealer_id || 'N/A'}</div>
                                                                                <div><span className="text-gray-400">Risk:</span>
                                                                                    <span className={`font-medium ${cd.risk_score > 0.6 ? 'text-red-600' : cd.risk_score > 0.3 ? 'text-yellow-600' : 'text-green-600'}`}>
                                                                                        {(cd.risk_score * 100).toFixed(0)}%
                                                                                    </span>
                                                                                    {cd.triage_class && <span className={`ml-1 text-xs px-1.5 py-0.5 rounded-full text-white ${cd.triage_class === 'AUTO_APPROVE' ? 'bg-green-500' : cd.triage_class === 'REVIEW' ? 'bg-yellow-500' : 'bg-red-500'}`}>{cd.triage_class.replace('_',' ')}</span>}
                                                                                </div>
                                                                            </div>
                                                                        </div>
                                                                    )}

                                                                    {/* Individual match reasons */}
                                                                    <div>
                                                                        <p className="font-semibold text-gray-700 mb-1 text-xs">
                                                                            <i className="fas fa-search-plus mr-1 text-orange-500"></i>Match Reasons ({group.reasons?.length})
                                                                        </p>
                                                                        {group.reasons?.map((r, ri) => {
                                                                            const mi = getMatchIcon(r.match_type);
                                                                            return (
                                                                                <div key={ri} className={`flex items-start space-x-2 p-2 rounded mb-1 ${mi.bg}`}>
                                                                                    <i className={`fas ${mi.icon} ${mi.color} mt-0.5`}></i>
                                                                                    <div className="flex-1">
                                                                                        <span className={`font-medium text-xs ${mi.color}`}>{r.match_type}</span>
                                                                                        <span className="text-xs text-gray-500 ml-2">({(r.similarity_score * 100).toFixed(0)}% match)</span>
                                                                                        {r.details && <p className="text-xs text-gray-600 mt-0.5">{r.details}</p>}
                                                                                        {(r.image_index_1 !== null || r.image_index_2 !== null) && (
                                                                                            <p className="text-xs text-gray-400">
                                                                                                Image #{r.image_index_1 ?? '?'} (this claim) vs Image #{r.image_index_2 ?? '?'} (linked)
                                                                                            </p>
                                                                                        )}
                                                                                    </div>
                                                                                </div>
                                                                            );
                                                                        })}
                                                                    </div>
                                                                </div>
                                                            )}
                                                        </div>
                                                    );
                                                })}

                                                {/* Fallback if audit not yet loaded */}
                                                {!dupAudit && result.duplicates_found.map((dup, idx) => (
                                                    <div key={idx} className="bg-white rounded-lg p-3 mb-2 border border-red-100">
                                                        <p className="font-medium text-red-600">{dup.match_type}</p>
                                                        <p className="text-sm text-gray-600">Matches claim: <ClaimLink claimId={dup.matched_claim_id} short={true} /></p>
                                                        <p className="text-sm text-gray-500">Similarity: {(dup.similarity_score * 100).toFixed(0)}%</p>
                                                    </div>
                                                ))}
                                            </div>
                                        )}

                                        {/* Fraud Signals */}
                                        {result.fraud_signals?.length > 0 && (
                                            <div>
                                                <h3 className="font-semibold text-gray-700 mb-3">
                                                    <i className="fas fa-flag mr-2 text-red-500"></i>Fraud Signals ({result.fraud_signals.length})
                                                </h3>
                                                <div className="space-y-2">
                                                    {result.fraud_signals.map((signal, idx) => (
                                                        <div key={idx} className={`rounded-lg p-3 ${getSeverityClass(signal.severity)}`}>
                                                            <div className="flex items-center justify-between">
                                                                <span className="font-medium text-sm">{signal.signal_type}</span>
                                                                <span className={`text-xs px-2 py-1 rounded-full ${
                                                                    signal.severity === 'HIGH' ? 'bg-red-500 text-white' :
                                                                    signal.severity === 'MEDIUM' ? 'bg-yellow-500 text-white' :
                                                                    'bg-green-500 text-white'
                                                                }`}>{signal.severity}</span>
                                                            </div>
                                                            <p className="text-sm text-gray-600 mt-1">{signal.description}</p>
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                        )}

                                        {/* Warnings */}
                                        {result.warnings?.length > 0 && (
                                            <div className="bg-yellow-50 rounded-xl p-4">
                                                <h3 className="font-semibold text-yellow-700 mb-2">
                                                    <i className="fas fa-exclamation-triangle mr-2"></i>Warnings
                                                </h3>
                                                <ul className="text-sm text-yellow-800 space-y-1">
                                                    {result.warnings.map((w, idx) => (
                                                        <li key={idx}>• {w}</li>
                                                    ))}
                                                </ul>
                                            </div>
                                        )}

                                        {/* Summary */}
                                        <div className="bg-gray-100 rounded-xl p-4">
                                            <h3 className="font-semibold text-gray-700 mb-2">
                                                <i className="fas fa-file-alt mr-2"></i>Summary
                                            </h3>
                                            <p className="text-gray-600">{result.summary}</p>
                                            <p className="text-xs text-gray-400 mt-2">
                                                Processing time: {result.processing_time_ms?.toFixed(0)}ms
                                            </p>
                                        </div>

                                        {/* Feedback Section */}
                                        <div className="border-t pt-4">
                                            <h3 className="font-semibold text-gray-700 mb-3">
                                                <i className="fas fa-comment-dots mr-2"></i>Adjuster Feedback
                                            </h3>
                                            {feedbackError && (
                                                <div className="bg-red-50 border border-red-200 rounded-lg p-3 mb-3 text-center">
                                                    <p className="text-red-700 text-sm">{feedbackError}</p>
                                                </div>
                                            )}
                                            {feedbackSubmitted ? (
                                                <div className="bg-green-50 border border-green-200 rounded-lg p-4 text-center">
                                                    <i className="fas fa-check-circle text-green-500 text-2xl mb-2"></i>
                                                    <p className="text-green-700">Feedback recorded: <strong>{feedbackVerdict}</strong></p>
                                                </div>
                                            ) : (
                                                <div className="flex space-x-3">
                                                    <button
                                                        onClick={() => submitFeedback('VALID_CLAIM')}
                                                        className="flex-1 py-3 bg-green-500 hover:bg-green-600 text-white rounded-lg transition"
                                                    >
                                                        <i className="fas fa-check mr-2"></i>Valid Claim
                                                    </button>
                                                    <button
                                                        onClick={() => submitFeedback('FALSE_POSITIVE')}
                                                        className="flex-1 py-3 bg-yellow-500 hover:bg-yellow-600 text-white rounded-lg transition"
                                                    >
                                                        <i className="fas fa-times mr-2"></i>False Positive
                                                    </button>
                                                    <button
                                                        onClick={() => submitFeedback('CONFIRMED_FRAUD')}
                                                        className="flex-1 py-3 bg-red-500 hover:bg-red-600 text-white rounded-lg transition"
                                                    >
                                                        <i className="fas fa-ban mr-2"></i>Confirmed Fraud
                                                    </button>
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                )}
                            </div>
                        </div>

                        {/* Detection Capabilities */}
                        <div className="mt-8 bg-white rounded-2xl card-shadow p-6">
                            <h2 className="text-xl font-bold text-gray-800 mb-6 text-center">
                                <i className="fas fa-shield-alt mr-2 text-blue-600"></i>
                                Fraud Detection Capabilities
                            </h2>
                            <div className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4">
                                {[
                                    { icon: 'fa-copy', title: 'Duplicate Images', desc: 'Same image across claims' },
                                    { icon: 'fa-id-card', title: 'VIN Validation', desc: 'Format & brand matching' },
                                    { icon: 'fa-tachometer-alt', title: 'Odometer Check', desc: 'Regression detection' },
                                    { icon: 'fa-calculator', title: 'Math Validation', desc: 'Total & ratio checks' },
                                    { icon: 'fa-clock', title: 'Labor Hours', desc: 'Rate & time anomalies' },
                                    { icon: 'fa-store', title: 'Dealer Patterns', desc: 'Spike & history analysis' },
                                    { icon: 'fa-calendar', title: 'Date Validation', desc: 'Future & warranty age' },
                                    { icon: 'fa-chart-line', title: 'Benchmarks', desc: 'Cost vs historical avg' },
                                    { icon: 'fa-redo', title: 'Repeat Claims', desc: 'Same VIN + issue' },
                                    { icon: 'fa-globe', title: 'Tax Geo Check', desc: 'Tax vs country rules' },
                                    { icon: 'fa-images', title: 'Image Count', desc: 'Policy compliance' },
                                    { icon: 'fa-user-tie', title: 'Dealer Risk', desc: 'Historical fraud rate' },
                                ].map((cap, idx) => (
                                    <div key={idx} className="text-center p-3 rounded-lg hover:bg-gray-50 transition">
                                        <i className={`fas ${cap.icon} text-2xl text-blue-500 mb-2`}></i>
                                        <p className="font-medium text-sm text-gray-700">{cap.title}</p>
                                        <p className="text-xs text-gray-400">{cap.desc}</p>
                                    </div>
                                ))}
                            </div>
                        </div>
                    </main>
                    )}

                    {/* ===================== DASHBOARD TAB ===================== */}
                    {activeTab === 'dashboard' && (
                    <main className="max-w-7xl mx-auto py-6 px-4 space-y-6">
                        {dashLoading && (
                            <div className="text-center py-16">
                                <div className="spinner mx-auto mb-4" style={{width:'48px',height:'48px'}}></div>
                                <p className="text-gray-500">Loading dashboard...</p>
                            </div>
                        )}

                        {!dashLoading && dashOverview && (
                            <React.Fragment>
                                {/* KPI Cards */}
                                <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4 fade-in">
                                    {[
                                        { icon:'fa-file-invoice', label:'Total Claims', value: dashOverview.total_claims, color:'bg-indigo-500', click: () => openDrilldown('all','','All Claims') },
                                        { icon:'fa-check-circle', label:'Auto Approved', value: dashOverview.by_triage?.AUTO_APPROVE||0, color:'bg-green-500', click: () => openDrilldown('triage','AUTO_APPROVE','Auto Approved') },
                                        { icon:'fa-exclamation-circle', label:'Review', value: dashOverview.by_triage?.REVIEW||0, color:'bg-yellow-500', click: () => openDrilldown('triage','REVIEW','Under Review') },
                                        { icon:'fa-exclamation-triangle', label:'Investigate', value: dashOverview.by_triage?.INVESTIGATE||0, color:'bg-red-500', click: () => openDrilldown('triage','INVESTIGATE','Investigate') },
                                        { icon:'fa-flag', label:'Suspicious', value: dashOverview.suspicious_count, color:'bg-red-600', click: () => openDrilldown('suspicious','','Suspicious Claims') },
                                        { icon:'fa-copy', label:'Duplicates', value: dashOverview.claims_with_duplicates, color:'bg-purple-500' },
                                    ].map((kpi, ki) => (
                                        <div key={ki} onClick={kpi.click}
                                            className={`${kpi.color} rounded-xl p-4 text-white card-shadow ${kpi.click ? 'cursor-pointer hover:scale-105 transition-transform' : ''}`}>
                                            <div className="flex items-center justify-between mb-2">
                                                <i className={`fas ${kpi.icon} text-lg opacity-80`}></i>
                                                <span className="text-2xl font-bold">{kpi.value}</span>
                                            </div>
                                            <p className="text-xs opacity-80">{kpi.label}</p>
                                        </div>
                                    ))}
                                </div>

                                {/* Row 1: Root Causes + Brand */}
                                <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                                    <div className="lg:col-span-2 bg-white rounded-2xl card-shadow p-5 fade-in">
                                        {dashRootCauses?.root_causes?.length > 0
                                            ? <ChartCanvas id="rcChart" config={{
                                                type:'bar',
                                                data:{
                                                    labels: dashRootCauses.root_causes.map(r => (r.issue_description||'Unknown').substring(0,30)),
                                                    datasets:[
                                                        {label:'Claims', data: dashRootCauses.root_causes.map(r=>r.claim_count), backgroundColor: DASH_COLORS[0]+'99', borderColor: DASH_COLORS[0], borderWidth:1},
                                                        {label:'Suspicious', data: dashRootCauses.root_causes.map(r=>r.suspicious_count), backgroundColor: DASH_COLORS[5]+'99', borderColor: DASH_COLORS[5], borderWidth:1},
                                                    ]
                                                },
                                                options:{responsive:true, indexAxis:'y',
                                                    onClick:(e,els)=>{ if(els.length) openDrilldown('issue', dashRootCauses.root_causes[els[0].index].issue_description, 'Issue: '+dashRootCauses.root_causes[els[0].index].issue_description); },
                                                    plugins:{legend:{position:'top'}, title:{display:true, text:'Claims by Root Cause (click to drill down)'}},
                                                    scales:{x:{beginAtZero:true}}}
                                            }} height={Math.max(200, (dashRootCauses.root_causes.length||5)*28)} />
                                            : <div className="flex items-center justify-center h-48 text-gray-300"><div className="text-center"><i className="fas fa-chart-bar text-4xl mb-2"></i><p className="text-sm">No root cause data</p></div></div>
                                        }
                                    </div>
                                    <div className="bg-white rounded-2xl card-shadow p-5 fade-in">
                                        {dashBrands?.brands?.length > 0
                                            ? <ChartCanvas id="brandChart" config={{
                                                type:'doughnut',
                                                data:{
                                                    labels: dashBrands.brands.map(b=>b.brand),
                                                    datasets:[{data: dashBrands.brands.map(b=>b.claim_count), backgroundColor: DASH_COLORS.slice(0,dashBrands.brands.length), borderWidth:2, borderColor:'#fff'}]
                                                },
                                                options:{responsive:true,
                                                    onClick:(e,els)=>{ if(els.length) openDrilldown('brand', dashBrands.brands[els[0].index].brand, 'Brand: '+dashBrands.brands[els[0].index].brand); },
                                                    plugins:{legend:{position:'right'}, title:{display:true, text:'Claims by Vehicle Brand'}}}
                                            }} height={280} />
                                            : <div className="flex items-center justify-center h-48 text-gray-300"><div className="text-center"><i className="fas fa-chart-pie text-4xl mb-2"></i><p className="text-sm">No brand data</p></div></div>
                                        }
                                    </div>
                                </div>

                                {/* Row 2: Trends + Dealers */}
                                <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                    <div className="bg-white rounded-2xl card-shadow p-5 fade-in">
                                        {dashTrends?.trends?.length > 0
                                            ? <ChartCanvas id="trendChart" config={{
                                                type:'line',
                                                data:{
                                                    labels: dashTrends.trends.map(t=>t.month),
                                                    datasets:[
                                                        {label:'Claims', data:dashTrends.trends.map(t=>t.claim_count), borderColor:DASH_COLORS[0], backgroundColor:DASH_COLORS[0]+'22', fill:true, tension:0.3},
                                                        {label:'Suspicious', data:dashTrends.trends.map(t=>t.suspicious_count), borderColor:DASH_COLORS[5], backgroundColor:DASH_COLORS[5]+'22', fill:true, tension:0.3},
                                                    ]
                                                },
                                                options:{responsive:true, plugins:{title:{display:true,text:'Claims Over Time'}}, scales:{y:{beginAtZero:true}}}
                                            }} height={250} />
                                            : <div className="flex items-center justify-center h-48 text-gray-300"><div className="text-center"><i className="fas fa-chart-line text-4xl mb-2"></i><p className="text-sm">No trend data</p></div></div>
                                        }
                                    </div>
                                    <div className="bg-white rounded-2xl card-shadow p-5 fade-in">
                                        {dashDealers?.dealers?.length > 0
                                            ? <ChartCanvas id="dealerChart" config={{
                                                type:'bar',
                                                data:{
                                                    labels: dashDealers.dealers.slice(0,10).map(d=>(d.dealer_name||d.dealer_id||'Unknown').substring(0,20)),
                                                    datasets:[
                                                        {label:'Claims', data:dashDealers.dealers.slice(0,10).map(d=>d.claim_count), backgroundColor:DASH_COLORS[4]+'99', borderColor:DASH_COLORS[4], borderWidth:1},
                                                        {label:'Suspicious', data:dashDealers.dealers.slice(0,10).map(d=>d.suspicious_count), backgroundColor:DASH_COLORS[5]+'99', borderColor:DASH_COLORS[5], borderWidth:1},
                                                    ]
                                                },
                                                options:{responsive:true,
                                                    onClick:(e,els)=>{ if(els.length) openDrilldown('dealer', dashDealers.dealers[els[0].index].dealer_id, 'Dealer: '+(dashDealers.dealers[els[0].index].dealer_name||dashDealers.dealers[els[0].index].dealer_id)); },
                                                    plugins:{legend:{position:'top'}, title:{display:true, text:'Top Dealers (click to drill down)'}},
                                                    scales:{y:{beginAtZero:true}}}
                                            }} height={250} />
                                            : <div className="flex items-center justify-center h-48 text-gray-300"><div className="text-center"><i className="fas fa-store text-4xl mb-2"></i><p className="text-sm">No dealer data</p></div></div>
                                        }
                                    </div>
                                </div>

                                {/* Row 3: Signals + Severity + Dup types */}
                                <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                                    <div className="lg:col-span-2 bg-white rounded-2xl card-shadow p-5 fade-in">
                                        {dashSignals?.signals?.length > 0
                                            ? <ChartCanvas id="sigChart" config={{
                                                type:'bar',
                                                data:{
                                                    labels: dashSignals.signals.slice(0,12).map(s=>s.signal_type.replace('DUPLICATE_IMAGE_','DUP_IMG_').replace('POTENTIAL_DUPLICATE_','DUP_')),
                                                    datasets:[{label:'Occurrences', data:dashSignals.signals.slice(0,12).map(s=>s.count), backgroundColor:DASH_COLORS.slice(0,12).map(c=>c+'99'), borderColor:DASH_COLORS.slice(0,12), borderWidth:1}]
                                                },
                                                options:{responsive:true, indexAxis:'y', plugins:{legend:{display:false}, title:{display:true,text:'Top Fraud Signals'}}, scales:{x:{beginAtZero:true}}}
                                            }} height={Math.max(200,(dashSignals.signals.length||5)*26)} />
                                            : <div className="flex items-center justify-center h-48 text-gray-300"><div className="text-center"><i className="fas fa-flag text-4xl mb-2"></i><p className="text-sm">No signals</p></div></div>
                                        }
                                    </div>
                                    <div className="bg-white rounded-2xl card-shadow p-5 fade-in space-y-4">
                                        {dashSignals?.by_severity && (
                                            <ChartCanvas id="sevChart" config={{
                                                type:'doughnut',
                                                data:{
                                                    labels:['High','Medium','Low'],
                                                    datasets:[{data:[dashSignals.by_severity.HIGH, dashSignals.by_severity.MEDIUM, dashSignals.by_severity.LOW], backgroundColor:['#ef444499','#f59e0b99','#22c55e99'], borderColor:['#ef4444','#f59e0b','#22c55e'], borderWidth:2}]
                                                },
                                                options:{responsive:true, plugins:{title:{display:true,text:'Signal Severity'}}}
                                            }} height={200} />
                                        )}
                                        {dashDupStats?.by_type?.length > 0 && (
                                            <div>
                                                <h4 className="font-semibold text-gray-700 text-sm mb-2"><i className="fas fa-copy mr-1 text-purple-500"></i>Duplicate Types</h4>
                                                {dashDupStats.by_type.map((dt,i) => (
                                                    <div key={i} className="flex items-center justify-between text-xs py-1 border-b border-gray-100">
                                                        <span className="text-gray-600">{dt.match_type}</span>
                                                        <span className="font-bold text-gray-800">{dt.cnt}</span>
                                                    </div>
                                                ))}
                                            </div>
                                        )}
                                    </div>
                                </div>

                                {/* Root cause detail table */}
                                {dashRootCauses?.root_causes?.length > 0 && (
                                    <div className="bg-white rounded-2xl card-shadow p-5 fade-in">
                                        <h3 className="font-bold text-gray-800 mb-3"><i className="fas fa-table mr-2 text-indigo-500"></i>Root Cause Detail</h3>
                                        <div className="overflow-x-auto">
                                            <table className="w-full text-sm">
                                                <thead className="bg-gray-50">
                                                    <tr>
                                                        <th className="text-left p-2 font-medium text-gray-600">Issue</th>
                                                        <th className="text-right p-2 font-medium text-gray-600">Claims</th>
                                                        <th className="text-right p-2 font-medium text-gray-600">Avg Amount</th>
                                                        <th className="text-right p-2 font-medium text-gray-600">Total</th>
                                                        <th className="text-right p-2 font-medium text-gray-600">Avg Risk</th>
                                                        <th className="text-right p-2 font-medium text-gray-600">Suspicious</th>
                                                        <th className="text-center p-2 font-medium text-gray-600">Action</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {dashRootCauses.root_causes.map((rc,i) => (
                                                        <tr key={i} className="border-b border-gray-100 hover:bg-gray-50">
                                                            <td className="p-2 font-medium max-w-[250px] truncate">{rc.issue_description}</td>
                                                            <td className="p-2 text-right">{rc.claim_count}</td>
                                                            <td className="p-2 text-right text-green-600">${rc.avg_amount?.toFixed(0)}</td>
                                                            <td className="p-2 text-right">${rc.total_amount?.toFixed(0)}</td>
                                                            <td className="p-2 text-right"><span className={rc.avg_risk>0.5?'text-red-600 font-bold':'text-gray-600'}>{(rc.avg_risk*100).toFixed(0)}%</span></td>
                                                            <td className="p-2 text-right">{rc.suspicious_count>0 ? <span className="bg-red-100 text-red-700 px-2 py-0.5 rounded-full text-xs font-bold">{rc.suspicious_count}</span> : <span className="text-gray-400">0</span>}</td>
                                                            <td className="p-2 text-center">
                                                                <button onClick={()=>openDrilldown('issue',rc.issue_description,rc.issue_description)} className="text-indigo-600 hover:text-indigo-800 text-xs font-medium"><i className="fas fa-arrow-right mr-1"></i>View</button>
                                                            </td>
                                                        </tr>
                                                    ))}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                )}

                                {/* ===== INLINE DRILLDOWN PANEL (replaces modal) ===== */}
                                {drilldown && (
                                    <div className="bg-white rounded-2xl card-shadow overflow-hidden fade-in" id="drilldown-panel">
                                        <div className="bg-indigo-600 text-white px-6 py-4 flex items-center justify-between">
                                            <div>
                                                <h3 className="font-bold text-lg"><i className="fas fa-list mr-2"></i>{drilldown.title}</h3>
                                                <p className="text-indigo-200 text-sm">{drillClaims ? `${drillClaims.total} claim(s)` : 'Loading...'}</p>
                                            </div>
                                            <button onClick={() => { setDrilldown(null); setDrillClaims(null); }} className="text-white hover:text-indigo-200 text-sm px-3 py-1.5 bg-white bg-opacity-20 hover:bg-opacity-30 rounded-lg transition">
                                                <i className="fas fa-times mr-1"></i>Close
                                            </button>
                                        </div>
                                        <div className="p-4">
                                            {drillLoading && <div className="text-center py-8"><div className="spinner mx-auto" style={{width:'32px',height:'32px'}}></div></div>}
                                            {drillClaims?.claims?.length > 0 && (
                                                <div className="overflow-x-auto">
                                                    <table className="w-full text-sm">
                                                        <thead className="bg-gray-50 sticky top-0">
                                                            <tr>
                                                                <th className="text-left p-2.5 font-medium text-gray-600">Claim ID</th>
                                                                <th className="text-left p-2.5 font-medium text-gray-600">Customer</th>
                                                                <th className="text-left p-2.5 font-medium text-gray-600">VIN</th>
                                                                <th className="text-left p-2.5 font-medium text-gray-600">Vehicle</th>
                                                                <th className="text-left p-2.5 font-medium text-gray-600">Issue</th>
                                                                <th className="text-left p-2.5 font-medium text-gray-600">Date</th>
                                                                <th className="text-right p-2.5 font-medium text-gray-600">Amount</th>
                                                                <th className="text-right p-2.5 font-medium text-gray-600">Risk</th>
                                                                <th className="text-center p-2.5 font-medium text-gray-600">Triage</th>
                                                                <th className="text-center p-2.5 font-medium text-gray-600">Suspicious</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            {drillClaims.claims.map((c,i) => (
                                                                <tr key={i} className="border-b border-gray-100 hover:bg-indigo-50 transition">
                                                                    <td className="p-2.5"><ClaimLink claimId={c.id} short={true} /></td>
                                                                    <td className="p-2.5 text-gray-700">{c.customer_name||'N/A'}</td>
                                                                    <td className="p-2.5 font-mono text-xs text-gray-600">{c.vin?.substring(0,11)||'N/A'}</td>
                                                                    <td className="p-2.5 text-gray-700">{c.brand} {c.model}</td>
                                                                    <td className="p-2.5 max-w-[220px] truncate text-gray-700" title={c.issue_description}>{c.issue_description}</td>
                                                                    <td className="p-2.5 text-gray-500 text-xs">{c.claim_date||'N/A'}</td>
                                                                    <td className="p-2.5 text-right text-green-600 font-medium">${c.total_amount?.toFixed(0)||'0'}</td>
                                                                    <td className="p-2.5 text-right"><span className={`font-bold ${c.risk_score>0.6?'text-red-600':c.risk_score>0.3?'text-yellow-600':'text-green-600'}`}>{(c.risk_score*100).toFixed(0)}%</span></td>
                                                                    <td className="p-2.5 text-center"><span className={`text-xs px-2 py-1 rounded-full font-bold text-white ${c.triage_class==='AUTO_APPROVE'?'bg-green-500':c.triage_class==='REVIEW'?'bg-yellow-500':'bg-red-500'}`}>{c.triage_class?.replace('_',' ')}</span></td>
                                                                    <td className="p-2.5 text-center">{c.is_suspicious ? <i className="fas fa-exclamation-triangle text-red-500"></i> : <i className="fas fa-check text-green-400"></i>}</td>
                                                                </tr>
                                                            ))}
                                                        </tbody>
                                                    </table>
                                                </div>
                                            )}
                                            {drillClaims?.claims?.length === 0 && !drillLoading && (
                                                <div className="text-center py-8 text-gray-400"><i className="fas fa-inbox text-4xl mb-2"></i><p>No claims found for this filter</p></div>
                                            )}
                                        </div>
                                    </div>
                                )}

                                {/* Refresh button */}
                                <div className="text-center">
                                    <button onClick={loadDashboard} className="px-6 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg text-sm transition">
                                        <i className="fas fa-sync-alt mr-2"></i>Refresh Dashboard
                                    </button>
                                </div>
                            </React.Fragment>
                        )}

                        {!dashLoading && !dashOverview && (
                            <div className="text-center py-16 text-gray-400">
                                <i className="fas fa-tachometer-alt text-6xl mb-4"></i>
                                <p>Dashboard data not loaded</p>
                                <button onClick={loadDashboard} className="mt-4 px-6 py-2 bg-indigo-600 text-white rounded-lg text-sm"><i className="fas fa-sync-alt mr-2"></i>Load Dashboard</button>
                            </div>
                        )}
                    </main>
                    )}

                    {/* ===================== CLAIM DETAIL MODAL (z-[60] to sit above drilldown) ===================== */}
                    {(claimModal || claimModalLoading) && (
                        <div className="fixed inset-0 bg-black bg-opacity-60 flex items-start justify-center pt-8 px-4" style={{zIndex:60}} onClick={() => { setClaimModal(null); setClaimModalLoading(false); }}>
                            <div className="bg-white rounded-2xl card-shadow w-full max-w-3xl max-h-[90vh] overflow-hidden" onClick={e => e.stopPropagation()}>
                                <div className="gradient-bg text-white px-6 py-4 flex items-center justify-between">
                                    <div>
                                        <h3 className="font-bold text-lg"><i className="fas fa-file-invoice mr-2"></i>Claim Details</h3>
                                        <p className="text-purple-200 text-sm font-mono">{claimModal?.id || '...'}</p>
                                    </div>
                                    <div className="flex items-center space-x-3">
                                        {claimModal?.pdf_available && (
                                            <a href={`${API_BASE_URL}/warranty/claim/${claimModal.id}/pdf`} target="_blank" rel="noopener noreferrer"
                                                className="px-3 py-1.5 bg-white bg-opacity-20 hover:bg-opacity-30 rounded-lg transition text-sm flex items-center">
                                                <i className="fas fa-external-link-alt mr-1.5"></i>Open PDF
                                            </a>
                                        )}
                                        <button onClick={() => { setClaimModal(null); setClaimModalLoading(false); }} className="text-white hover:text-purple-200 text-xl"><i className="fas fa-times"></i></button>
                                    </div>
                                </div>
                                <div className="overflow-auto max-h-[80vh] p-5">
                                    {claimModalLoading && <div className="text-center py-8"><div className="spinner mx-auto" style={{width:'40px',height:'40px'}}></div></div>}
                                    {claimModal?._error && <div className="bg-red-50 p-4 rounded-lg text-red-700"><i className="fas fa-exclamation-circle mr-2"></i>{claimModal._error}</div>}
                                    {claimModal && !claimModal._error && (
                                        <div className="space-y-4">
                                            {/* Triage badge */}
                                            <div className="text-center">
                                                <span className={`inline-flex items-center px-4 py-2 rounded-full text-white font-bold ${claimModal.triage_class === 'AUTO_APPROVE' ? 'bg-green-500' : claimModal.triage_class === 'REVIEW' ? 'bg-yellow-500' : 'bg-red-500'}`}>
                                                    {claimModal.triage_class?.replace('_',' ')}
                                                </span>
                                                <p className="text-gray-500 text-sm mt-1">Risk: <span className="font-bold">{((claimModal.risk_score||0)*100).toFixed(0)}%</span></p>
                                            </div>
                                            {/* Details grid */}
                                            <div className="grid grid-cols-2 gap-3 text-sm bg-gray-50 rounded-xl p-4">
                                                <div><span className="text-gray-400">Customer:</span> <span className="font-medium">{claimModal.customer_name||'N/A'}</span></div>
                                                <div><span className="text-gray-400">Dealer:</span> <span className="font-medium">{claimModal.dealer_name||claimModal.dealer_id||'N/A'}</span></div>
                                                <div><span className="text-gray-400">VIN:</span> <span className="font-mono text-xs">{claimModal.vin||'N/A'}</span></div>
                                                <div><span className="text-gray-400">Vehicle:</span> <span className="font-medium">{claimModal.brand} {claimModal.model} ({claimModal.year})</span></div>
                                                <div><span className="text-gray-400">Issue:</span> <span className="font-medium">{claimModal.issue_description||'N/A'}</span></div>
                                                <div><span className="text-gray-400">Claim Date:</span> <span className="font-medium">{claimModal.claim_date||'N/A'}</span></div>
                                                <div><span className="text-gray-400">Parts:</span> <span className="text-green-600">${claimModal.parts_cost?.toFixed(2)||'0.00'}</span></div>
                                                <div><span className="text-gray-400">Labor:</span> <span className="text-green-600">${claimModal.labor_cost?.toFixed(2)||'0.00'}</span></div>
                                                <div><span className="text-gray-400">Tax:</span> <span className="text-green-600">${claimModal.tax?.toFixed(2)||'0.00'}</span></div>
                                                <div><span className="text-gray-400">Total:</span> <span className="font-bold text-green-600">${claimModal.total_amount?.toFixed(2)||'0.00'}</span></div>
                                                <div><span className="text-gray-400">Status:</span> <span className="font-medium">{claimModal.status||'N/A'}</span></div>
                                                <div><span className="text-gray-400">Suspicious:</span> {claimModal.is_suspicious ? <span className="text-red-600 font-bold">Yes</span> : <span className="text-green-600">No</span>}</div>
                                            </div>

                                            {/* PDF Viewer */}
                                            {claimModal.pdf_available && (
                                                <div>
                                                    <h4 className="font-semibold text-sm text-gray-700 mb-2"><i className="fas fa-file-pdf mr-1 text-red-500"></i>Original Document</h4>
                                                    <iframe
                                                        src={`${API_BASE_URL}/warranty/claim/${claimModal.id}/pdf`}
                                                        className="w-full rounded-lg border border-gray-200"
                                                        style={{height:'500px'}}
                                                        title="Claim PDF"
                                                    />
                                                </div>
                                            )}
                                            {!claimModal.pdf_available && (
                                                <div className="bg-gray-50 rounded-lg p-3 text-center text-gray-400 text-sm">
                                                    <i className="fas fa-file-pdf text-2xl mb-1"></i>
                                                    <p>Original PDF not available (uploaded before PDF storage was enabled)</p>
                                                </div>
                                            )}

                                            {/* Fraud signals */}
                                            {claimModal.fraud_signals && (() => {
                                                try {
                                                    const sigs = typeof claimModal.fraud_signals === 'string' ? JSON.parse(claimModal.fraud_signals) : claimModal.fraud_signals;
                                                    if (Array.isArray(sigs) && sigs.length > 0) return (
                                                        <div>
                                                            <h4 className="font-semibold text-sm text-gray-700 mb-2"><i className="fas fa-flag mr-1 text-red-500"></i>Fraud Signals ({sigs.length})</h4>
                                                            {sigs.map((s,si) => (
                                                                <div key={si} className={`rounded p-2 mb-1 text-xs ${s.severity==='HIGH'?'signal-high':s.severity==='MEDIUM'?'signal-medium':'signal-low'}`}>
                                                                    <span className="font-medium">{s.signal_type}</span>
                                                                    {s.description && <span className="text-gray-500 ml-2">{s.description}</span>}
                                                                </div>
                                                            ))}
                                                        </div>
                                                    );
                                                } catch(e) {}
                                                return null;
                                            })()}
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Footer */}
                    <footer className="bg-gray-800 text-white py-6 mt-8">
                        <div className="max-w-7xl mx-auto px-4 text-center">
                            <p className="text-gray-400">
                                <i className="fas fa-shield-alt mr-2"></i>
                                VeriReceipt Warranty Claims Module - ML-Powered Fraud Detection
                            </p>
                        </div>
                    </footer>
                </div>
            );
        }

        /* ChartCanvas — reusable Chart.js wrapper */
        function ChartCanvas({ id, config, height = 300 }) {
            const ref = React.useRef(null);
            const chartRef = React.useRef(null);
            React.useEffect(() => {
                if (!ref.current || !config) return;
                if (chartRef.current) chartRef.current.destroy();
                chartRef.current = new Chart(ref.current, config);
                return () => { if (chartRef.current) chartRef.current.destroy(); };
            }, [config]);
            return <canvas ref={ref} id={id} height={height}></canvas>;
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
