<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Human Review - VeriReceipt</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        .split-screen {
            display: grid;
            grid-template-columns: 1fr 1fr;
            height: 100vh;
            overflow: hidden;
        }
        
        .receipt-viewer {
            background: #f3f4f6;
            overflow: auto;
            position: relative;
        }
        
        .review-form {
            background: white;
            overflow: auto;
            border-left: 2px solid #e5e7eb;
        }
        
        .zoom-controls {
            position: sticky;
            top: 0;
            z-index: 10;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid #e5e7eb;
            padding: 1rem;
        }
        
        .receipt-image {
            transition: transform 0.2s;
            transform-origin: top left;
        }
        
        .checkbox-label {
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .checkbox-label:hover {
            background: #f3f4f6;
        }
        
        .submit-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .submit-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect } = React;
        
        function ReviewPage() {
            const [receipt, setReceipt] = useState(null);
            const [loading, setLoading] = useState(true);
            const [humanLabel, setHumanLabel] = useState('');
            const [indicatorReviews, setIndicatorReviews] = useState({});
            const [missedIndicators, setMissedIndicators] = useState([]);
            const [corrections, setCorrections] = useState({});
            const [additionalNotes, setAdditionalNotes] = useState('');
            const [zoom, setZoom] = useState(1.0);
            const [submitting, setSubmitting] = useState(false);
            const [submitted, setSubmitted] = useState(false);
            
            // Get receipt ID from URL
            const receiptId = new URLSearchParams(window.location.search).get('id');
            
            useEffect(() => {
                // Load receipt data from sessionStorage (set by main page)
                const storedData = sessionStorage.getItem('currentReceipt');
                console.log('=== REVIEW PAGE LOADING ===');
                console.log('Stored data exists:', !!storedData);
                console.log('Stored data length:', storedData ? storedData.length : 0);
                
                if (storedData) {
                    try {
                        const data = JSON.parse(storedData);
                        console.log('Parsed data:', data);
                        console.log('Image URL:', data.image_url ? data.image_url.substring(0, 50) + '...' : '‚ùå MISSING');
                        console.log('Models:', data.models);
                        
                        setReceipt({
                            id: receiptId || data.receipt_id || 'unknown',
                            image_url: data.image_url || data.uploaded_image || '',
                            verdict: data.verdict || data.final_label || 'suspicious',
                            confidence: data.confidence || 0.5,
                            models: data.models || {
                                rule_based: { verdict: 'unknown', score: 0 },
                                donut: { verdict: 'unknown' },
                                donut_receipt: {},
                                layoutlm: { verdict: 'unknown' },
                                vision_llm: { verdict: 'unknown' }
                            },
                            extracted: data.extracted || {}
                        });
                        setLoading(false);
                    } catch (e) {
                        console.error('Error loading receipt data:', e);
                        // Fallback to basic data
                        setReceipt({
                            id: receiptId || 'unknown',
                            image_url: '',
                            verdict: 'suspicious',
                            confidence: 0.5,
                            models: {
                                rule_based: { verdict: 'unknown', score: 0 },
                                donut: { verdict: 'unknown' },
                                donut_receipt: {},
                                layoutlm: { verdict: 'unknown' },
                                vision_llm: { verdict: 'unknown' }
                            },
                            extracted: {}
                        });
                        setLoading(false);
                    }
                } else {
                    // No stored data - use minimal fallback
                    setReceipt({
                        id: receiptId || 'unknown',
                        image_url: '',
                        verdict: 'suspicious',
                        confidence: 0.5,
                        models: {
                            rule_based: { verdict: 'unknown', score: 0 },
                            donut: { verdict: 'unknown' },
                            donut_receipt: {},
                            layoutlm: { verdict: 'unknown' },
                            vision_llm: { verdict: 'unknown' }
                        },
                        extracted: {}
                    });
                    setLoading(false);
                }
            }, [receiptId]);
            
            const handleIndicatorReview = (indicator, status, note = '') => {
                setIndicatorReviews({
                    ...indicatorReviews,
                    [indicator]: { status, note }
                });
            };
            
            const handleMissedIndicatorToggle = (indicator) => {
                if (missedIndicators.includes(indicator)) {
                    setMissedIndicators(missedIndicators.filter(i => i !== indicator));
                } else {
                    setMissedIndicators([...missedIndicators, indicator]);
                }
            };
            
            const handleSubmit = async () => {
                if (!humanLabel) {
                    alert('Please select a verdict (Real/Suspicious/Fake)');
                    return;
                }
                
                setSubmitting(true);
                
                // Prepare comprehensive feedback
                const falseIndicators = Object.entries(indicatorReviews)
                    .filter(([_, review]) => review.status === 'wrong')
                    .map(([indicator, review]) => `${indicator}: ${review.note || 'No reason provided'}`);
                
                const confirmedIndicators = Object.entries(indicatorReviews)
                    .filter(([_, review]) => review.status === 'correct')
                    .map(([indicator, _]) => indicator);
                
                const feedbackData = {
                    receipt_id: receipt.id || 'unknown',
                    correct_verdict: humanLabel.toLowerCase(),
                    user_notes: additionalNotes || null,
                    missed_indicators: missedIndicators,
                    false_indicators: falseIndicators,
                    confirmed_indicators: confirmedIndicators,
                    data_corrections: corrections,
                    software_detected: receipt.models?.rule_based?.reasons?.find(r => r.includes('Software'))?.match(/'([^']+)'/)?.[1] || null,
                    has_spacing_issue: missedIndicators.includes('spacing_anomalies'),
                    has_date_issue: missedIndicators.includes('date_manipulation')
                };
                
                console.log('Submitting feedback to new API:', feedbackData);
                
                try {
                    const response = await fetch('http://localhost:8000/feedback/submit', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(feedbackData)
                    });
                    
                    console.log('Response status:', response.status);
                    
                    if (response.ok) {
                        const result = await response.json();
                        console.log('Feedback submitted successfully:', result);
                        
                        // Show success message with learning info
                        if (result.rules_updated > 0 || result.new_patterns_learned.length > 0) {
                            alert(`‚úÖ Feedback submitted!\n\n` +
                                  `Rules updated: ${result.rules_updated}\n` +
                                  `New patterns learned: ${result.new_patterns_learned.join(', ') || 'None'}\n\n` +
                                  `The system will learn from your correction.`);
                        }
                        
                        setSubmitted(true);
                        setTimeout(() => {
                            window.location.href = '/';
                        }, 2000);
                    } else {
                        const error = await response.json();
                        console.error('Server error:', error);
                        alert(`Failed to submit feedback: ${error.detail || 'Unknown error'}`);
                    }
                } catch (error) {
                    console.error('Error submitting feedback:', error);
                    alert(`Error submitting feedback: ${error.message}`);
                } finally {
                    setSubmitting(false);
                }
            };
            
            if (loading) {
                return (
                    <div className="flex items-center justify-center h-screen">
                        <div className="text-center">
                            <i className="fas fa-spinner fa-spin text-4xl text-purple-600 mb-4"></i>
                            <p className="text-gray-600">Loading receipt...</p>
                        </div>
                    </div>
                );
            }
            
            if (submitted) {
                return (
                    <div className="flex items-center justify-center h-screen bg-green-50">
                        <div className="text-center">
                            <i className="fas fa-check-circle text-6xl text-green-600 mb-4"></i>
                            <h2 className="text-2xl font-bold text-gray-800 mb-2">Feedback Submitted!</h2>
                            <p className="text-gray-600">Thank you for helping improve our AI models.</p>
                            <p className="text-sm text-gray-500 mt-2">Redirecting to home...</p>
                        </div>
                    </div>
                );
            }
            
            return (
                <div className="split-screen">
                    {/* Left: Receipt Image Viewer */}
                    <div className="receipt-viewer">
                        <div className="zoom-controls">
                            <div className="flex items-center justify-between">
                                <div className="flex items-center space-x-2">
                                    <button 
                                        onClick={() => setZoom(z => Math.min(z + 0.2, 3.0))}
                                        className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition"
                                    >
                                        <i className="fas fa-search-plus mr-2"></i>
                                        Zoom In
                                    </button>
                                    <button 
                                        onClick={() => setZoom(z => Math.max(z - 0.2, 0.5))}
                                        className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition"
                                    >
                                        <i className="fas fa-search-minus mr-2"></i>
                                        Zoom Out
                                    </button>
                                    <button 
                                        onClick={() => setZoom(1.0)}
                                        className="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition"
                                    >
                                        <i className="fas fa-undo mr-2"></i>
                                        Reset
                                    </button>
                                </div>
                                <div className="text-sm text-gray-600">
                                    Zoom: {(zoom * 100).toFixed(0)}%
                                </div>
                            </div>
                        </div>
                        
                        <div className="p-6">
                            {receipt.image_url ? (
                                receipt.image_url.includes('AAAAGGZ0eXBoZWlj') || receipt.image_url.includes('ftypheic') ? (
                                    // HEIC data - try to load from server instead
                                    <img 
                                        src={`http://localhost:8000/receipt/${receipt.id}/image`}
                                        alt="Receipt"
                                        className="receipt-image border-2 border-gray-300 shadow-lg rounded-lg"
                                        style={{ transform: `scale(${zoom})` }}
                                        onLoad={() => console.log('‚úÖ Server image loaded')}
                                        onError={(e) => {
                                            console.error('‚ùå Failed to load server image');
                                            e.target.onerror = null;
                                            e.target.src = 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="400" height="600"><rect width="400" height="600" fill="%23f3f4f6"/><text x="50%" y="50%" text-anchor="middle" fill="%236b7280" font-size="16">HEIC Image</text><text x="50%" y="55%" text-anchor="middle" fill="%239ca3af" font-size="12">Browser cannot display HEIC</text></svg>';
                                        }}
                                    />
                                ) : (
                                    <img 
                                        src={receipt.image_url}
                                        alt="Receipt"
                                        className="receipt-image border-2 border-gray-300 shadow-lg rounded-lg"
                                        style={{ transform: `scale(${zoom})` }}
                                        onLoad={() => console.log('‚úÖ Image loaded')}
                                        onError={(e) => {
                                            console.error('‚ùå Image load failed:', receipt.image_url.substring(0, 50));
                                            e.target.onerror = null;
                                            e.target.src = 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="400" height="600"><rect width="400" height="600" fill="%23f3f4f6"/><text x="50%" y="50%" text-anchor="middle" fill="%236b7280" font-size="16">Image Load Failed</text></svg>';
                                        }}
                                    />
                                )
                            ) : (
                                <div className="border-2 border-gray-300 shadow-lg rounded-lg p-8 bg-gray-50 text-center">
                                    <i className="fas fa-image text-6xl text-gray-400 mb-4"></i>
                                    <p className="text-gray-500">No image preview available</p>
                                    <p className="text-xs text-gray-400 mt-2">Receipt ID: {receipt.id}</p>
                                </div>
                            )}
                        </div>
                    </div>
                    
                    {/* Right: Review Form */}
                    <div className="review-form p-8">
                        <div className="max-w-2xl">
                            {/* Header */}
                            <div className="mb-8">
                                <div className="flex justify-between items-start mb-4">
                                    <div>
                                        <h1 className="text-3xl font-bold text-gray-800 mb-2">
                                            <i className="fas fa-clipboard-check text-purple-600 mr-3"></i>
                                            Human Review
                                        </h1>
                                        <p className="text-gray-600">
                                            Review the AI analysis and provide your expert feedback to improve the system.
                                        </p>
                                    </div>
                                    <a 
                                        href="/index.html"
                                        className="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-all duration-200 flex items-center"
                                    >
                                        <i className="fas fa-home mr-2"></i>
                                        Home
                                    </a>
                                </div>
                            </div>
                            
                            {/* AI Verdict Summary */}
                            <div className="mb-8 p-6 bg-yellow-50 border-2 border-yellow-200 rounded-xl">
                                <h2 className="font-bold text-gray-800 mb-3 flex items-center">
                                    <i className="fas fa-robot text-yellow-600 mr-2"></i>
                                    AI Verdict
                                </h2>
                                <div className="space-y-2">
                                    <div className="flex justify-between items-center">
                                        <span className="text-gray-700">Overall:</span>
                                        <span className={`font-bold text-lg uppercase ${
                                            receipt.verdict === 'fake' ? 'text-red-600' :
                                            receipt.verdict === 'suspicious' ? 'text-yellow-600' :
                                            'text-green-600'
                                        }`}>
                                            {receipt.verdict}
                                        </span>
                                    </div>
                                    <div className="flex justify-between items-center">
                                        <span className="text-gray-700">Confidence:</span>
                                        <span className="font-semibold">{(receipt.confidence * 100).toFixed(1)}%</span>
                                    </div>
                                    
                                    <div className="mt-4 pt-4 border-t border-yellow-300">
                                        <div className="text-sm font-semibold text-gray-700 mb-3">Model Results:</div>
                                        <div className="space-y-3 text-sm">
                                            {/* Rule-Based */}
                                            <div className="bg-white p-3 rounded border">
                                                <div className="flex justify-between items-center mb-2">
                                                    <span className="font-semibold text-gray-700">Rule-Based:</span>
                                                    <span className={`font-bold ${receipt.models.rule_based?.label === 'fake' ? 'text-red-600' : receipt.models.rule_based?.label === 'suspicious' ? 'text-yellow-600' : 'text-green-600'}`}>
                                                        {receipt.models.rule_based?.label || 'N/A'}
                                                    </span>
                                                </div>
                                                {receipt.models.rule_based?.score !== undefined && (
                                                    <div className="text-xs text-gray-600 mb-1">Score: {(receipt.models.rule_based.score * 100).toFixed(0)}%</div>
                                                )}
                                                {receipt.models.rule_based?.reasons && receipt.models.rule_based.reasons.length > 0 && (
                                                    <div className="text-xs text-gray-600 mt-2">
                                                        <div className="font-semibold mb-1">Fraud Indicators ({receipt.models.rule_based.reasons.length}):</div>
                                                        <ul className="list-disc list-inside space-y-2">
                                                            {receipt.models.rule_based.reasons.map((reason, i) => (
                                                                <li key={i} className="whitespace-pre-wrap">{reason}</li>
                                                            ))}
                                                        </ul>
                                                        {receipt.models.rule_based?.minor_notes && receipt.models.rule_based.minor_notes.length > 0 && (
                                                            <div className="mt-2 pt-2 border-t border-gray-200">
                                                                <div className="font-semibold mb-1">Minor Notes ({receipt.models.rule_based.minor_notes.length}):</div>
                                                                <ul className="list-disc list-inside space-y-1">
                                                                    {receipt.models.rule_based.minor_notes.map((note, i) => (
                                                                        <li key={i} className="text-gray-500">{note}</li>
                                                                    ))}
                                                                </ul>
                                                            </div>
                                                        )}
                                                    </div>
                                                )}
                                            </div>
                                            
                                            {/* DONUT */}
                                            <div className="bg-white p-3 rounded border">
                                                <div className="flex justify-between items-center mb-2">
                                                    <span className="font-semibold text-gray-700">DONUT:</span>
                                                    <span className="font-bold">{receipt.models.donut?.data_quality || 'N/A'}</span>
                                                </div>
                                                {receipt.models.donut && (
                                                    <div className="text-xs text-gray-600 space-y-1">
                                                        <div>Items: {receipt.models.donut.line_items_count || 0}</div>
                                                        {receipt.models.donut.merchant && <div>Merchant: {receipt.models.donut.merchant}</div>}
                                                        {receipt.models.donut.total && typeof receipt.models.donut.total === 'object' && (
                                                            <div>Total: {receipt.models.donut.total.total_price || 'N/A'}</div>
                                                        )}
                                                    </div>
                                                )}
                                            </div>
                                            
                                            {/* Donut-Receipt */}
                                            <div className="bg-white p-3 rounded border">
                                                <div className="flex justify-between items-center mb-2">
                                                    <span className="font-semibold text-gray-700">Donut-Receipt:</span>
                                                    <span className="font-bold">{receipt.models.donut_receipt?.error ? '‚ùå Error' : receipt.models.donut_receipt?.status || 'N/A'}</span>
                                                </div>
                                                {receipt.models.donut_receipt && !receipt.models.donut_receipt.error && (
                                                    <div className="text-xs text-gray-600 space-y-1">
                                                        <div>Items: {receipt.models.donut_receipt.items_count || 0}</div>
                                                        {receipt.models.donut_receipt.merchant && Object.keys(receipt.models.donut_receipt.merchant).length > 0 && (
                                                            <div>Merchant: {receipt.models.donut_receipt.merchant.name || 'N/A'}</div>
                                                        )}
                                                        {receipt.models.donut_receipt.total && <div>Total: {receipt.models.donut_receipt.total}</div>}
                                                        {receipt.models.donut_receipt.date && <div>Date: {receipt.models.donut_receipt.date}</div>}
                                                    </div>
                                                )}
                                            </div>
                                            
                                            {/* LayoutLM */}
                                            <div className="bg-white p-3 rounded border">
                                                <div className="flex justify-between items-center mb-2">
                                                    <span className="font-semibold text-gray-700">LayoutLM:</span>
                                                    <span className="font-bold">{receipt.models.layoutlm?.data_quality || 'N/A'}</span>
                                                </div>
                                                {receipt.models.layoutlm && (
                                                    <div className="text-xs text-gray-600 space-y-1">
                                                        <div>Words: {receipt.models.layoutlm.words_extracted || 0}</div>
                                                        {receipt.models.layoutlm.merchant && <div>Merchant: {receipt.models.layoutlm.merchant}</div>}
                                                        {receipt.models.layoutlm.total && <div>Total: {receipt.models.layoutlm.total}</div>}
                                                        {receipt.models.layoutlm.date && <div>Date: {receipt.models.layoutlm.date}</div>}
                                                        {receipt.models.layoutlm.confidence && <div>Confidence: {receipt.models.layoutlm.confidence}</div>}
                                                    </div>
                                                )}
                                            </div>
                                            
                                            {/* Vision LLM */}
                                            <div className="bg-white p-3 rounded border">
                                                <div className="flex justify-between items-center mb-2">
                                                    <span className="font-semibold text-gray-700">Vision LLM:</span>
                                                    <span className={`font-bold ${receipt.models.vision_llm?.verdict === 'fake' ? 'text-red-600' : receipt.models.vision_llm?.verdict === 'suspicious' ? 'text-yellow-600' : 'text-green-600'}`}>
                                                        {receipt.models.vision_llm?.verdict || 'N/A'}
                                                    </span>
                                                </div>
                                                {receipt.models.vision_llm?.confidence !== undefined && (
                                                    <div className="text-xs text-gray-600 mb-1">Confidence: {(receipt.models.vision_llm.confidence * 100).toFixed(0)}%</div>
                                                )}
                                                {receipt.models.vision_llm?.reasoning && (
                                                    <div className="text-xs text-gray-600 mt-2 italic">"{receipt.models.vision_llm.reasoning}"</div>
                                                )}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            {/* Human Assessment */}
                            <div className="mb-8">
                                <h2 className="font-bold text-gray-800 mb-4 text-xl">
                                    <i className="fas fa-user-check text-indigo-600 mr-2"></i>
                                    Your Assessment
                                </h2>
                                <div className="space-y-3">
                                    {['real', 'suspicious', 'fake'].map(label => (
                                        <label 
                                            key={label}
                                            className={`checkbox-label flex items-center p-4 border-2 rounded-lg cursor-pointer ${
                                                humanLabel === label 
                                                    ? 'border-purple-600 bg-purple-50' 
                                                    : 'border-gray-300 hover:border-purple-300'
                                            }`}
                                        >
                                            <input 
                                                type="radio" 
                                                name="label" 
                                                value={label}
                                                checked={humanLabel === label}
                                                onChange={(e) => setHumanLabel(e.target.value)}
                                                className="mr-3 w-5 h-5"
                                            />
                                            <span className={`font-bold text-lg uppercase ${
                                                label === 'real' ? 'text-green-600' :
                                                label === 'suspicious' ? 'text-yellow-600' :
                                                'text-red-600'
                                            }`}>
                                                {label}
                                            </span>
                                        </label>
                                    ))}
                                </div>
                            </div>
                            
                            {/* Review AI Fraud Indicators */}
                            {receipt.models.rule_based?.reasons && receipt.models.rule_based.reasons.length > 0 && (
                                <div className="mb-8">
                                    <h2 className="font-bold text-gray-800 mb-4 text-xl">
                                        <i className="fas fa-search text-indigo-600 mr-2"></i>
                                        Review AI Fraud Indicators ({receipt.models.rule_based.reasons.length})
                                    </h2>
                                    <p className="text-sm text-gray-600 mb-4">
                                        For each indicator the AI detected, tell us if it was correct or a false alarm:
                                    </p>
                                    <div className="space-y-4">
                                        {receipt.models.rule_based.reasons.map((indicator, idx) => (
                                            <div key={idx} className="border-2 border-gray-300 rounded-lg p-4 bg-gray-50">
                                                <div className="text-sm text-gray-700 mb-3 font-medium">{indicator}</div>
                                                <div className="flex items-center space-x-4 mb-2">
                                                    <label className="flex items-center cursor-pointer">
                                                        <input 
                                                            type="radio"
                                                            name={`indicator_${idx}`}
                                                            value="correct"
                                                            checked={indicatorReviews[indicator]?.status === 'correct'}
                                                            onChange={() => handleIndicatorReview(indicator, 'correct')}
                                                            className="mr-2"
                                                        />
                                                        <span className="text-green-600 font-semibold">‚úÖ Correct</span>
                                                    </label>
                                                    <label className="flex items-center cursor-pointer">
                                                        <input 
                                                            type="radio"
                                                            name={`indicator_${idx}`}
                                                            value="wrong"
                                                            checked={indicatorReviews[indicator]?.status === 'wrong'}
                                                            onChange={() => handleIndicatorReview(indicator, 'wrong')}
                                                            className="mr-2"
                                                        />
                                                        <span className="text-red-600 font-semibold">‚ùå False Alarm</span>
                                                    </label>
                                                    <label className="flex items-center cursor-pointer">
                                                        <input 
                                                            type="radio"
                                                            name={`indicator_${idx}`}
                                                            value="uncertain"
                                                            checked={indicatorReviews[indicator]?.status === 'uncertain'}
                                                            onChange={() => handleIndicatorReview(indicator, 'uncertain')}
                                                            className="mr-2"
                                                        />
                                                        <span className="text-gray-600">ü§∑ Uncertain</span>
                                                    </label>
                                                </div>
                                                {indicatorReviews[indicator]?.status === 'wrong' && (
                                                    <div className="mt-3">
                                                        <label className="block text-xs text-gray-600 mb-1">Why is this a false alarm?</label>
                                                        <input 
                                                            type="text"
                                                            placeholder="e.g., TCPDF is commonly used for invoicing"
                                                            className="w-full border border-gray-300 rounded px-3 py-2 text-sm"
                                                            onChange={(e) => handleIndicatorReview(indicator, 'wrong', e.target.value)}
                                                        />
                                                    </div>
                                                )}
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}
                            
                            {/* Missed Fraud Indicators */}
                            <div className="mb-8">
                                <h2 className="font-bold text-gray-800 mb-4 text-xl">
                                    <i className="fas fa-exclamation-triangle text-orange-600 mr-2"></i>
                                    Missed Fraud Indicators
                                </h2>
                                <p className="text-sm text-gray-600 mb-4">
                                    Did the AI miss any fraud signals? Check all that apply:
                                </p>
                                <div className="space-y-2">
                                    {[
                                        { id: 'spacing_anomalies', label: 'Spacing anomalies (excessive spaces, irregular gaps)' },
                                        { id: 'font_inconsistencies', label: 'Font inconsistencies (mixed fonts, sizes)' },
                                        { id: 'watermark_issues', label: 'Watermark or logo issues' },
                                        { id: 'suspicious_merchant', label: 'Suspicious merchant name' },
                                        { id: 'invalid_address', label: 'Invalid or fake address' },
                                        { id: 'invalid_phone', label: 'Invalid or fake phone number' },
                                        { id: 'date_manipulation', label: 'Date manipulation or backdating' },
                                        { id: 'amount_tampering', label: 'Amount tampering or alteration' },
                                        { id: 'poor_image_quality', label: 'Poor image quality (screenshot, low-res)' },
                                        { id: 'missing_elements', label: 'Missing critical receipt elements' }
                                    ].map(missed => (
                                        <label 
                                            key={missed.id}
                                            className="flex items-center p-3 border-2 rounded-lg cursor-pointer hover:bg-orange-50 transition"
                                        >
                                            <input 
                                                type="checkbox"
                                                checked={missedIndicators.includes(missed.id)}
                                                onChange={() => handleMissedIndicatorToggle(missed.id)}
                                                className="mr-3 w-4 h-4"
                                            />
                                            <span className="text-gray-700">{missed.label}</span>
                                        </label>
                                    ))}
                                </div>
                            </div>
                            
                            {/* Corrections */}
                            <div className="mb-8">
                                <h2 className="font-bold text-gray-800 mb-4 text-xl">
                                    <i className="fas fa-edit text-indigo-600 mr-2"></i>
                                    Corrections (if AI was wrong)
                                </h2>
                                <div className="space-y-4">
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-2">
                                            Merchant Name:
                                        </label>
                                        <input 
                                            type="text"
                                            defaultValue={receipt.extracted.merchant?.name}
                                            onChange={(e) => setCorrections({...corrections, merchant: e.target.value})}
                                            className="w-full border-2 border-gray-300 rounded-lg px-4 py-2 focus:border-purple-600 focus:outline-none"
                                            placeholder="Enter correct merchant name"
                                        />
                                    </div>
                                    
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-2">
                                            Total Amount:
                                        </label>
                                        <input 
                                            type="number"
                                            step="0.01"
                                            defaultValue={receipt.extracted.total}
                                            onChange={(e) => setCorrections({...corrections, total: parseFloat(e.target.value)})}
                                            className="w-full border-2 border-gray-300 rounded-lg px-4 py-2 focus:border-purple-600 focus:outline-none"
                                            placeholder="Enter correct total"
                                        />
                                    </div>
                                    
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-2">
                                            Tax Amount:
                                        </label>
                                        <input 
                                            type="number"
                                            step="0.01"
                                            defaultValue={receipt.extracted.tax?.amount}
                                            onChange={(e) => setCorrections({...corrections, tax: parseFloat(e.target.value)})}
                                            className="w-full border-2 border-gray-300 rounded-lg px-4 py-2 focus:border-purple-600 focus:outline-none"
                                            placeholder="Enter correct tax amount"
                                        />
                                    </div>
                                    
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-2">
                                            Date:
                                        </label>
                                        <input 
                                            type="date"
                                            defaultValue={receipt.extracted.date}
                                            onChange={(e) => setCorrections({...corrections, date: e.target.value})}
                                            className="w-full border-2 border-gray-300 rounded-lg px-4 py-2 focus:border-purple-600 focus:outline-none"
                                        />
                                    </div>
                                </div>
                            </div>
                            
                            {/* Additional Notes */}
                            <div className="mb-8">
                                <h2 className="font-bold text-gray-800 mb-4 text-xl">
                                    <i className="fas fa-comment text-indigo-600 mr-2"></i>
                                    Additional Notes (Optional)
                                </h2>
                                <textarea 
                                    value={additionalNotes}
                                    onChange={(e) => setAdditionalNotes(e.target.value)}
                                    className="w-full border-2 border-gray-300 rounded-lg px-4 py-3 focus:border-purple-600 focus:outline-none"
                                    rows="4"
                                    placeholder="Any other observations or comments about this receipt..."
                                />
                            </div>
                            
                            {/* Submit Button */}
                            <div className="flex space-x-4">
                                <button 
                                    onClick={handleSubmit}
                                    disabled={!humanLabel || submitting}
                                    className="submit-button flex-1 py-4 text-white font-bold rounded-lg transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed"
                                >
                                    {submitting ? (
                                        <>
                                            <i className="fas fa-spinner fa-spin mr-2"></i>
                                            Submitting...
                                        </>
                                    ) : (
                                        <>
                                            <i className="fas fa-paper-plane mr-2"></i>
                                            Submit Feedback
                                        </>
                                    )}
                                </button>
                                
                                <button 
                                    onClick={() => window.location.href = '/'}
                                    className="px-6 py-4 bg-gray-300 text-gray-700 font-bold rounded-lg hover:bg-gray-400 transition"
                                >
                                    <i className="fas fa-times mr-2"></i>
                                    Cancel
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }
        
        ReactDOM.render(<ReviewPage />, document.getElementById('root'));
    </script>
</body>
</html>
